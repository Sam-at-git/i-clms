# åˆåŒè§£æå¤šç­–ç•¥æ‰©å±•éœ€æ±‚è§„æ ¼

**ç‰ˆæœ¬**: v1.1
**æ—¥æœŸ**: 2026-01-22
**ç›®æ ‡**: æé«˜åˆåŒä¿¡æ¯æå–å‡†ç¡®ç‡ï¼Œæä¾›å¤šç§è§£ææ–¹å¼äº¤å‰éªŒè¯

---

## ä¸€ã€èƒŒæ™¯ä¸ç›®æ ‡

### 1.1 ç°çŠ¶
é¡¹ç›®å·²å®ç°ä¸¤ç§åˆåŒè§£ææ–¹å¼ï¼š
- **æ–¹å¼1ï¼šåŸºäºè§„åˆ™/ç¨‹åºé€»è¾‘** - ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼å’Œç¨‹åºé€»è¾‘æå–å­—æ®µ
- **æ–¹å¼2ï¼šLLMåˆ†ä»»åŠ¡è§£æ** - å°†åˆåŒåˆ†è§£ä¸º8ä¸ªä¸»é¢˜ï¼Œä¸²è¡Œè°ƒç”¨LLMæå–

### 1.2 ç›®æ ‡
æ‰©å±•æ›´å¤šè§£æç­–ç•¥ï¼Œå®ç°ï¼š
- **A. æé«˜å‡†ç¡®ç‡** - ä¸åŒç±»å‹åˆåŒé€‚ç”¨ä¸åŒè§£ææ–¹å¼
- **C. äº¤å‰éªŒè¯** - å¤šç§æ–¹å¼ç»“æœå¯¹æ¯”ï¼Œæé«˜å¯é æ€§

### 1.3 å·²ç¡®è®¤å†³ç­–
| å†³ç­–é¡¹ | ç»“è®º |
|--------|------|
| DSPyå®ç° | **æš‚ç¼“å¼€å‘**ï¼Œæœªæ¥è¯„ä¼° |
| å‘é‡åµŒå…¥æ¨¡å‹ | **å¼€æºæ¨¡å‹**ï¼Œç•Œé¢å¯é…ç½® |
| æ¨¡å‹é…ç½® | LLMå’ŒåµŒå…¥æ¨¡å‹éƒ½éœ€è¦"æµ‹è¯•è¿æ¥"åŠŸèƒ½ |
| ç¼“å­˜ç­–ç•¥ | å¤šçº§ç¼“å­˜ï¼ˆè§ç¬¬åç« ï¼‰ |
| å‡†ç¡®ç‡è¯„ä¼° | **LLMè¯„ä¼°è¿‘ä¼¼åº¦**ï¼ˆè§ç¬¬åä¸€ç« ï¼‰ |

---

## äºŒã€è§£æç­–ç•¥å…¨æ™¯

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      åˆåŒè§£æå¤šç­–ç•¥æ¶æ„                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚  ç­–ç•¥é€‰æ‹©å±‚  â”‚  â”‚  ç”¨æˆ·ç•Œé¢   â”‚  â”‚  ç³»ç»Ÿé…ç½®   â”‚             â”‚
â”‚  â”‚ (å•é€‰/å¤šé€‰)  â”‚  â”‚ (ç­–ç•¥é€‰æ‹©å™¨) â”‚  â”‚ (é»˜è®¤ç­–ç•¥)  â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚         â”‚                                                       â”‚
â”‚         â–¼                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                    æ–‡æ¡£é¢„å¤„ç†å±‚                           â”‚  â”‚
â”‚  â”‚  DOCX/PDF/å›¾ç‰‡PDF â”€â”€â–º Docling â”€â”€â–º Markdown + å¸ƒå±€ä¿¡æ¯    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚         â”‚                                                       â”‚
â”‚         â–¼                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                    è§£æç­–ç•¥å±‚                             â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚  è§„åˆ™è§£æ   â”‚  LLMä»»åŠ¡å¼  â”‚  RAGå‘é‡æ£€ç´¢è§£æ             â”‚  â”‚
â”‚  â”‚  (ç°æœ‰)     â”‚  (ç°æœ‰)     â”‚  (æ–°å¢)                      â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚              Doclingç›´æ¥æå– (æ–°å¢)                      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚         â”‚                    â”‚                                 â”‚
â”‚         â–¼                    â–¼                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                    å¤šçº§ç¼“å­˜å±‚                            â”‚  â”‚
â”‚  â”‚  æ–‡æ¡£æŒ‡çº¹ç¼“å­˜ â”‚ å‘é‡åµŒå…¥ç¼“å­˜ â”‚ LLMç»“æœç¼“å­˜                â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚         â”‚                                                       â”‚
â”‚         â–¼                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                    ç»“æœéªŒè¯å±‚                             â”‚  â”‚
â”‚  â”‚  å•ç­–ç•¥: ç›´æ¥é‡‡ç”¨ â”‚ å¤šç­–ç•¥: æŠ•ç¥¨æœºåˆ¶ / LLMè¯„ä¼°            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å½“å‰å®ç°çš„è§£æç­–ç•¥

| ç­–ç•¥ | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| è§„åˆ™/ç¨‹åºé€»è¾‘è§£æ | âœ… å·²å®ç° | æ­£åˆ™è¡¨è¾¾å¼æå– |
| LLMåˆ†ä»»åŠ¡è§£æ | âœ… å·²å®ç° | 8ä¸ªä¸»é¢˜ä¸²è¡Œæå– |
| Doclingæ–‡æ¡£è§£æ | ğŸš§ å¼€å‘ä¸­ | ç»Ÿä¸€æ–‡æ¡£é¢„å¤„ç† |
| RAGå‘é‡æ£€ç´¢è§£æ | â³ è®¡åˆ’ä¸­ | pgvector + å¼€æºåµŒå…¥ |
| DSPyç¨‹åºåŒ–æå– | â¸ï¸ æš‚ç¼“ | æœªæ¥è¯„ä¼° |

---

## ä¸‰ã€å„è§£æç­–ç•¥è¯¦è§£

### 3.1 ç­–ç•¥1ï¼šè§„åˆ™/ç¨‹åºé€»è¾‘è§£æï¼ˆç°æœ‰ï¼‰

**æè¿°**: ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼å’Œç¨‹åºé€»è¾‘æå–20+ä¸ªå­—æ®µ

**ä¼˜åŠ¿**: å¿«é€Ÿã€å…è´¹ã€ç¡®å®šæ€§å¼º
**åŠ£åŠ¿**: å¤æ‚æ¡æ¬¾æ— æ³•å¤„ç†ï¼Œå‡†ç¡®ç‡æœ‰é™

**é€‚ç”¨åœºæ™¯**: æ ¼å¼è§„èŒƒçš„æ¨¡æ¿åˆåŒ

---

### 3.2 ç­–ç•¥2ï¼šLLMåˆ†ä»»åŠ¡è§£æï¼ˆç°æœ‰ï¼‰

**æè¿°**: å°†åˆåŒåˆ†è§£ä¸º8ä¸ªä¸»é¢˜ä»»åŠ¡ï¼Œä¸²è¡Œæ‰§è¡Œ

**ä»»åŠ¡ç±»å‹**:
- `BASIC_INFO` - åŸºæœ¬ä¿¡æ¯
- `FINANCIAL` - è´¢åŠ¡ä¿¡æ¯
- `MILESTONES` - é‡Œç¨‹ç¢‘
- `RATE_ITEMS` - è´¹ç‡é¡¹
- `LINE_ITEMS` - è¡Œé¡¹ç›®
- `RISK_CLAUSES` - é£é™©æ¡æ¬¾
- `DELIVERABLES` - äº¤ä»˜ç‰©
- `TIME_INFO` - æ—¶é—´ä¿¡æ¯

**ä¼˜åŠ¿**: èƒ½ç†è§£å¤æ‚è¯­ä¹‰
**åŠ£åŠ¿**: æˆæœ¬è¾ƒé«˜ã€é€Ÿåº¦è¾ƒæ…¢

---

### 3.3 ç­–ç•¥3ï¼šDoclingè§£æï¼ˆæ–°å¢ï¼‰

**æè¿°**: ä½¿ç”¨Doclingåº“çš„æ–‡æ¡£è§£æå’Œæå–èƒ½åŠ›

**Doclingèƒ½åŠ›**:
- æ–‡æ¡£è½¬Markdownï¼ˆä¿ç•™å¸ƒå±€ä¿¡æ¯ï¼‰
- è¡¨æ ¼æå–
- OCRï¼ˆå¤„ç†æ‰«æä»¶ï¼‰
- å­—æ®µæå–ï¼ˆåŸºäºæ–‡æ¡£ç»“æ„ï¼‰

**é›†æˆæ–¹å¼**:
```typescript
// ä¼ªä»£ç 
const doclingResult = await DoclingParser.parse(document);
const markdown = doclingResult.markdown;  // ç”¨äºå…¶ä»–ç­–ç•¥
const extractedFields = doclingResult.extractFields(topics);  // ç›´æ¥æå–
```

**å¯¹æ¯”ç›®æ ‡**: ä¸ç°æœ‰mammoth/docx4js/pdf-parseå¯¹æ¯”ï¼Œæ‹©ä¼˜

---

### 3.4 ç­–ç•¥4ï¼šDSPyç¨‹åºåŒ–æå–ï¼ˆâ¸ï¸ æš‚ç¼“ï¼‰

**çŠ¶æ€**: æš‚ç¼“å¼€å‘ï¼Œæœªæ¥è¯„ä¼°

**æš‚ç¼“åŸå› **: å½“å‰ä¼˜å…ˆå®ç°Doclingå’ŒRAGï¼ŒDSPyä½œä¸ºå¤‡é€‰æ–¹æ¡ˆä¿ç•™

**æœªæ¥ä»·å€¼**: ç¨‹åºåŒ–ç»“æ„åŒ–æ•°æ®æå–ï¼Œå¯èƒ½æä¾›æ›´é«˜çš„å‡†ç¡®ç‡

---

### 3.5 ç­–ç•¥4ï¼šRAGå‘é‡æ£€ç´¢è§£æï¼ˆæ–°å¢ï¼‰

**æè¿°**: å°†åˆåŒå‘é‡åŒ–å­˜å‚¨ï¼Œé’ˆå¯¹æ¯ä¸ªä¸»é¢˜åšè¯­ä¹‰æ£€ç´¢+LLMæå–

**æµç¨‹**:
```
1. æ–‡æ¡£åˆ‡åˆ† â†’ æŒ‰è¯­ä¹‰æ®µè½åˆ†å—ï¼ˆ500-1000å­—ï¼‰
2. å‘é‡åŒ– â†’ ä½¿ç”¨å¼€æºåµŒå…¥æ¨¡å‹
3. å­˜å‚¨ â†’ pgvectorå­˜å‚¨åµŒå…¥å‘é‡
4. æ£€ç´¢ â†’ é’ˆå¯¹æ¯ä¸ªä¸»é¢˜æ„é€ æŸ¥è¯¢ï¼Œæ‰¾åˆ°ç›¸å…³æ®µè½ï¼ˆTop-Kï¼‰
5. æå– â†’ LLMä»æ£€ç´¢ç»“æœä¸­æå–ç­”æ¡ˆ
```

**å‘é‡åµŒå…¥æ¨¡å‹é…ç½®**ï¼ˆå¯ç•Œé¢é…ç½®ï¼‰:

| æ¨¡å‹ç±»å‹ | æ¨èæ¨¡å‹ | ç»´åº¦ | è¯´æ˜ |
|----------|----------|------|------|
| æœ¬åœ°æ¨¡å‹ | `nomic-ai/nomic-embed-text-v1.5` | 768 | Ollamaæ”¯æŒ |
| æœ¬åœ°æ¨¡å‹ | `mxbai-embed-large` | 1024 | Ollamaæ”¯æŒ |
| æœ¬åœ°æ¨¡å‹ | `all-minilm` | 384 | è½»é‡çº§ï¼Œå¿«é€Ÿ |
| äº‘ç«¯API | OpenAI `text-embedding-3-small` | 1536 | å¤‡é€‰æ–¹æ¡ˆ |

**ç³»ç»Ÿé…ç½®ç•Œé¢**:
```typescript
interface EmbeddingModelConfig {
  provider: 'ollama' | 'openai' | 'huggingface';
  model: string;              // å¦‚ 'nomic-embed-text'
  baseUrl?: string;           // Ollamaåœ°å€
  dimensions: number;         // å‘é‡ç»´åº¦
  testConnection?: () => Promise<boolean>;  // æµ‹è¯•è¿æ¥
}
```

**å‘é‡åº“**: PostgreSQL + pgvectoræ‰©å±•

**æŸ¥è¯¢ç¤ºä¾‹**:
| ä¸»é¢˜ | æŸ¥è¯¢å‘é‡ |
|------|----------|
| åˆåŒé‡‘é¢ | "åˆåŒæ€»é‡‘é¢ã€ä»·æ¬¾ã€è´¹ç”¨" |
| äº¤è´§æ—¶é—´ | "äº¤ä»˜æ—¥æœŸã€å±¥è¡ŒæœŸé™ã€å®Œæˆæ—¶é—´" |
| è¿çº¦è´£ä»» | "è¿çº¦æ¡æ¬¾ã€èµ”å¿è´£ä»»ã€è¿çº¦é‡‘" |

---

## å››ã€å¯æ‰©å±•ä¸»é¢˜æ¶æ„

### 4.1 ç°æœ‰ä¸»é¢˜

```typescript
enum ExtractTopic {
  BASIC_INFO,      // åŸºæœ¬ä¿¡æ¯
  FINANCIAL,       // è´¢åŠ¡ä¿¡æ¯
  MILESTONES,      // é‡Œç¨‹ç¢‘
  RATE_ITEMS,      // è´¹ç‡é¡¹
  LINE_ITEMS,      // è¡Œé¡¹ç›®
  RISK_CLAUSES,    // é£é™©æ¡æ¬¾
  DELIVERABLES,    // äº¤ä»˜ç‰©
  TIME_INFO        // æ—¶é—´ä¿¡æ¯
}
```

### 4.2 æ‰©å±•æœºåˆ¶ï¼ˆå¼€å‘è€…çº§åˆ«ï¼‰

**ç›®æ ‡**: æ–°å¢ä¸»é¢˜æ—¶ï¼Œåªéœ€æ·»åŠ é…ç½®/ç±»ï¼Œä¸ä¿®æ”¹æ ¸å¿ƒè§£æé€»è¾‘

**è®¾è®¡æ€è·¯**:
```typescript
// ä¸»é¢˜å®šä¹‰æ¥å£
interface ExtractTopicDefinition {
  name: string;
  description: string;
  fields: FieldDefinition[];
  prompt?: string;          // LLM promptæ¨¡æ¿
  query?: string;           // RAGæŸ¥è¯¢æ¨¡æ¿
  weight?: number;          // å®Œæ•´æ€§è¯„åˆ†æƒé‡
}

// æ–°å¢ä¸»é¢˜ç¤ºä¾‹
const PENALTY_CLAUSES: ExtractTopicDefinition = {
  name: 'PENALTY_CLAUSES',
  description: 'è¿çº¦æ¡æ¬¾',
  fields: [
    { name: 'penaltyRate', type: 'decimal', required: false },
    { name: 'penaltyDescription', type: 'string', required: false }
  ],
  prompt: 'æå–åˆåŒä¸­çš„è¿çº¦è´£ä»»æ¡æ¬¾...',
  query: 'è¿çº¦è´£ä»»ã€é€¾æœŸä»˜æ¬¾ã€è¿çº¦é‡‘',
  weight: 5
};
```

**æ–‡ä»¶ç»“æ„**:
```
apps/api/src/llm-parser/
â”œâ”€â”€ topics/
â”‚   â”œâ”€â”€ topic.interface.ts        # ä¸»é¢˜å®šä¹‰æ¥å£
â”‚   â”œâ”€â”€ basic-info.topic.ts       # åŸºæœ¬ä¿¡æ¯ä¸»é¢˜
â”‚   â”œâ”€â”€ financial.topic.ts        # è´¢åŠ¡ä¸»é¢˜
â”‚   â”œâ”€â”€ ...
â”‚   â””â”€â”€ penalty-clauses.topic.ts  # æ–°å¢ä¸»é¢˜ç¤ºä¾‹
â”œâ”€â”€ strategies/
â”‚   â”œâ”€â”€ rule.strategy.ts
â”‚   â”œâ”€â”€ llm.strategy.ts
â”‚   â”œâ”€â”€ docling.strategy.ts
â”‚   â””â”€â”€ rag.strategy.ts
â”œâ”€â”€ cache/
â”‚   â”œâ”€â”€ cache.service.ts          # å¤šçº§ç¼“å­˜æœåŠ¡
â”‚   â”œâ”€â”€ document-fingerprint.ts   # æ–‡æ¡£æŒ‡çº¹ç¼“å­˜
â”‚   â”œâ”€â”€ embedding-cache.ts        # å‘é‡åµŒå…¥ç¼“å­˜
â”‚   â””â”€â”€ llm-result-cache.ts       # LLMç»“æœç¼“å­˜
â”œâ”€â”€ evaluation/
â”‚   â”œâ”€â”€ llm-evaluator.service.ts  # LLMè¯„ä¼°æœåŠ¡
â”‚   â””â”€â”€ similarity-prompts.ts     # ç›¸ä¼¼åº¦è¯„ä¼°Prompt
â””â”€â”€ topic-registry.service.ts     # ä¸»é¢˜æ³¨å†ŒæœåŠ¡
```

---

## äº”ã€ç”¨æˆ·äº¤äº’æ¨¡å¼

### 5.1 ç­–ç•¥é€‰æ‹©

**å‰ç«¯é…ç½®**:
```typescript
// ç³»ç»Ÿé…ç½® - é»˜è®¤ç­–ç•¥
interface ParseStrategyConfig {
  defaultStrategy: ParseStrategy;
  enableMultiStrategy: boolean;
  voteThreshold: number;  // æŠ•ç¥¨é˜ˆå€¼
}

// ç”¨æˆ·ä¸Šä¼ æ—¶é€‰æ‹©
interface ParseOptions {
  strategy: ParseStrategy | 'multi';  // å•é€‰æˆ–å¤šç­–ç•¥
  strategies?: ParseStrategy[];       // å¤šé€‰æ—¶æŒ‡å®š
}
```

**ç•Œé¢è®¾è®¡**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è§£æç­–ç•¥                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â—‹ è§„åˆ™è§£æ (æœ€å¿«ï¼Œå…è´¹)               â”‚
â”‚  â—‹ LLMæ™ºèƒ½è§£æ (æ¨è)                  â”‚
â”‚  â—‹ Doclingè§£æ (æ–°å¢)                  â”‚
â”‚  â—‹ RAGå‘é‡æ£€ç´¢ (æ–°å¢)                  â”‚
â”‚  â—‹ å¤šç­–ç•¥äº¤å‰éªŒè¯ (æœ€å‡†ç¡®)              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [å¼€å§‹è§£æ]                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 ç»“æœå±•ç¤º

**å•ç­–ç•¥æ¨¡å¼**: ç›´æ¥å±•ç¤ºç»“æœ

**å¤šç­–ç•¥æ¨¡å¼**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è§£æç»“æœå¯¹æ¯”                                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  å­—æ®µ    â”‚  è§„åˆ™    â”‚   LLM    â”‚  RAG     â”‚  é‡‡ç”¨ç»“æœ  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  åˆåŒé‡‘é¢ â”‚  (æœªæå–)â”‚ Â¥100,000 â”‚ Â¥100,000 â”‚ Â¥100,000 âœ“ â”‚
â”‚  ç­¾çº¦æ—¥æœŸ â”‚ 2024-01  â”‚ 2024-01  â”‚ 2024-01  â”‚ 2024-01 âœ“  â”‚
â”‚  äº¤è´§æ—¶é—´ â”‚ 2024-06  â”‚ 2024-07  â”‚ 2024-06  â”‚ âš  éœ€ç¡®è®¤   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## å…­ã€å†²çªè§£å†³æœºåˆ¶ï¼ˆæŠ•ç¥¨æœºåˆ¶ï¼‰

### 6.1 æŠ•ç¥¨è§„åˆ™

```typescript
interface VoteConfig {
  threshold: number;  // é€šè¿‡é˜ˆå€¼ï¼Œé»˜è®¤0.6ï¼ˆ60%ï¼‰
  strategies: {
    [key: string]: {
      weight: number;  // ç­–ç•¥æƒé‡
      enabled: boolean;
    }
  }
}

// ç¤ºä¾‹é…ç½®
const voteConfig: VoteConfig = {
  threshold: 0.6,
  strategies: {
    rule: { weight: 1.0, enabled: true },
    llm: { weight: 1.2, enabled: true },      // LLMæƒé‡æ›´é«˜
    docling: { weight: 1.1, enabled: true },
    rag: { weight: 1.3, enabled: true }       // RAGæƒé‡æœ€é«˜
  }
};
```

### 6.2 å†³ç­–é€»è¾‘

```
1. æ”¶é›†å„ç­–ç•¥ç»“æœ
2. å½’ä¸€åŒ–å¤„ç†ï¼ˆç»Ÿä¸€æ ¼å¼ï¼‰
3. åŠ æƒæŠ•ç¥¨
4. è®¡ç®—ç½®ä¿¡åº¦
   - ä¸€è‡´ç‡ >= é˜ˆå€¼: è‡ªåŠ¨é‡‡ç”¨
   - ä¸€è‡´ç‡ < é˜ˆå€¼: ä½¿ç”¨LLMè¯„ä¼°ç›¸ä¼¼åº¦ï¼ˆè§ç¬¬åä¸€ç« ï¼‰
5. è®°å½•å†³ç­–ä¾æ®ï¼ˆå®¡è®¡ï¼‰
```

---

## ä¸ƒã€æŠ€æœ¯æ ˆä¸ä¾èµ–

### 7.1 æ–°å¢ä¾èµ–

```json
{
  "dependencies": {
    "@docling/document": "^latest",     // æ–‡æ¡£è§£æ
    "pgvector": "^latest"               // PostgreSQLå‘é‡æ‰©å±•
  }
}
```

### 7.2 åŸºç¡€è®¾æ–½

| ç»„ä»¶ | ç”¨é€” | è¯´æ˜ |
|------|------|------|
| PostgreSQL + pgvector | å‘é‡å­˜å‚¨ | åˆåŒæ®µè½åµŒå…¥ |
| Docling | æ–‡æ¡£è§£æ | PDF/å›¾ç‰‡â†’Markdownï¼ˆå«OCRï¼‰ |
| Ollama | åµŒå…¥æ¨¡å‹ | æœ¬åœ°å‘é‡åµŒå…¥ï¼ˆnomic-embed-textç­‰ï¼‰ |
| OpenAI/Ollama | LLMè°ƒç”¨ | ç°æœ‰åŸºç¡€è®¾æ–½ |
| Redis (å¯é€‰) | åˆ†å¸ƒå¼ç¼“å­˜ | æœªæ¥å¤šå®ä¾‹éƒ¨ç½²æ—¶è€ƒè™‘ |

### 7.3 åµŒå…¥æ¨¡å‹æ¨èï¼ˆå¯ç•Œé¢é…ç½®ï¼‰

| æ¨¡å‹ | ç»´åº¦ | Ollamaåç§° | è¯´æ˜ |
|------|------|------------|------|
| Nomic Embed Text | 768 | `nomic-embed-text` | æ¨èï¼Œæ”¯æŒä¸­æ–‡ |
| MXBAI Embed Large | 1024 | `mxbai-embed-large` | é«˜ç²¾åº¦ |
| All-MiniLM | 384 | `all-minilm` | è½»é‡çº§ï¼Œå¿«é€Ÿ |
| BGE Large | 1024 | `bge-large-zh-v1.5` | ä¸­æ–‡ä¼˜åŒ– |

---

## å…«ã€å¼€å‘ä¼˜å…ˆçº§

### Phase 1: åŸºç¡€è®¾æ–½ï¼ˆå½“å‰ä¼˜å…ˆï¼‰
1. â³ é›†æˆDocling - æ–‡æ¡£è½¬Markdown
2. â³ å¯æ‰©å±•ä¸»é¢˜æ¶æ„ - æ’ä»¶å¼ä¸»é¢˜å®šä¹‰
3. â³ pgvectoræ‰©å±• - å‘é‡å­˜å‚¨åŸºç¡€
4. â³ å¤šçº§ç¼“å­˜æœåŠ¡

### Phase 2: æ–°ç­–ç•¥å®ç°
5. â³ Doclingæå–ç­–ç•¥
6. â³ RAGå‘é‡æ£€ç´¢ç­–ç•¥

### Phase 3: ç”¨æˆ·ä½“éªŒ
7. â³ ç­–ç•¥é€‰æ‹©ç•Œé¢
8. â³ æ¨¡å‹é…ç½®ç•Œé¢ï¼ˆLLM + åµŒå…¥æ¨¡å‹ + æµ‹è¯•è¿æ¥ï¼‰
9. â³ å¤šç­–ç•¥ç»“æœå¯¹æ¯”å±•ç¤º
10. â³ æŠ•ç¥¨æœºåˆ¶å®ç°

### Phase 4: ä¼˜åŒ–ä¸è¯„ä¼°
11. â³ LLMè¯„ä¼°æœåŠ¡
12. â³ æ€§èƒ½ä¼˜åŒ–
13. â³ æˆæœ¬ä¼˜åŒ–

### æš‚ç¼“é¡¹ç›®
- â¸ï¸ DSPyç¨‹åºåŒ–æå– - æœªæ¥è¯„ä¼°

---

## ä¹ã€æˆåŠŸæ ‡å‡†

### 9.1 åŠŸèƒ½å®Œæ•´æ€§
- [ ] æ”¯æŒ4ç§è§£æç­–ç•¥ï¼ˆè§„åˆ™ã€LLMã€Doclingã€RAGï¼‰
- [ ] ç”¨æˆ·å¯é€‰æ‹©å•/å¤šç­–ç•¥
- [ ] æ–°å¢ä¸»é¢˜æ— éœ€ä¿®æ”¹æ ¸å¿ƒä»£ç 
- [ ] æ‰«æä»¶PDFæ”¯æŒOCR
- [ ] åµŒå…¥æ¨¡å‹å¯é…ç½®ï¼Œå¸¦æµ‹è¯•è¿æ¥åŠŸèƒ½

### 9.2 è´¨é‡æ ‡å‡†
- [ ] å¤šç­–ç•¥äº¤å‰éªŒè¯å‡†ç¡®ç‡ > å•ä¸€ç­–ç•¥
- [ ] è§£ææ—¶é—´å¯æ¥å—ï¼ˆRAG < 30ç§’ï¼‰
- [ ] å•å…ƒæµ‹è¯•è¦†ç›–ç‡ â‰¥ 80%
- [ ] LLMè¯„ä¼°ç›¸ä¼¼åº¦å¯ç”¨

### 9.3 ç”¨æˆ·ä½“éªŒ
- [ ] ç­–ç•¥é€‰æ‹©ç•Œé¢æ¸…æ™°
- [ ] ç»“æœå¯¹æ¯”ç›´è§‚
- [ ] å†²çªå¤„ç†æœ‰æ˜ç¡®æç¤º

---

## åã€å¤šçº§ç¼“å­˜ç­–ç•¥

### 10.1 ç¼“å­˜å±‚çº§

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ç¼“å­˜æ¶æ„                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                          â”‚
â”‚  L1: æ–‡æ¡£æŒ‡çº¹ç¼“å­˜ (Redis / å†…å­˜)                         â”‚
â”‚  â”œâ”€â”€ Key: SHA256(æ–‡ä»¶å†…å®¹)                              â”‚
â”‚  â”œâ”€â”€ Value: è§£æç»“æœå…¨æ–‡                                â”‚
â”‚  â””â”€â”€ TTL: 7å¤©                                          â”‚
â”‚                                                          â”‚
â”‚  L2: å‘é‡åµŒå…¥ç¼“å­˜ (PostgreSQL)                           â”‚
â”‚  â”œâ”€â”€ Key: SHA256(æ–‡æœ¬å—) + æ¨¡å‹åç§°                      â”‚
â”‚  â”œâ”€â”€ Value: åµŒå…¥å‘é‡                                    â”‚
â”‚  â””â”€â”€ TTL: æ°¸ä¹…ï¼ˆç›¸åŒæ–‡æœ¬+æ¨¡å‹æ°¸è¿œç›¸åŒï¼‰                  â”‚
â”‚                                                          â”‚
â”‚  L3: LLMç»“æœç¼“å­˜ (PostgreSQL)                            â”‚
â”‚  â”œâ”€â”€ Key: SHA256(Prompt + è¾“å…¥) + æ¨¡å‹åç§°               â”‚
â”‚  â”œâ”€â”€ Value: LLMè¾“å‡º                                     â”‚
â”‚  â””â”€â”€ TTL: 30å¤©                                          â”‚
â”‚                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 10.2 ç¼“å­˜å®ç°

```typescript
// ç¼“å­˜æœåŠ¡æ¥å£
interface CacheStrategy {
  get<T>(key: string): Promise<T | null>;
  set<T>(key: string, value: T, ttl?: number): Promise<void>;
  invalidate(pattern: string): Promise<void>;
}

// æ–‡æ¡£æŒ‡çº¹ç¼“å­˜
class DocumentFingerprintCache {
  async getCachedResult(fileHash: string): Promise<ParseResult | null> {
    // åŒä¸€æ–‡ä»¶çš„è§£æç»“æœç›´æ¥å¤ç”¨
  }
}

// å‘é‡åµŒå…¥ç¼“å­˜
class EmbeddingCache {
  async getCachedEmbedding(text: string, model: string): Promise<number[] | null> {
    // ç›¸åŒæ–‡æœ¬+æ¨¡å‹çš„åµŒå…¥ç»“æœæ°¸ä¹…å¤ç”¨
  }
}

// LLMç»“æœç¼“å­˜
class LLMResultCache {
  async getCachedResponse(prompt: string, input: string, model: string): Promise<string | null> {
    // ç›¸åŒPrompt+è¾“å…¥+æ¨¡å‹çš„è¾“å‡ºå¤ç”¨
  }
}
```

### 10.3 ç¼“å­˜é…ç½®

```typescript
interface CacheConfig {
  enabled: boolean;
  level1: {
    provider: 'memory' | 'redis';
    ttl: number;  // ç§’
  };
  level2: {
    enabled: boolean;
    tableName: string;  // embedding_cache
  };
  level3: {
    enabled: boolean;
    tableName: string;  // llm_cache
    ttl: number;
  };
}

const defaultCacheConfig: CacheConfig = {
  enabled: true,
  level1: { provider: 'memory', ttl: 7 * 24 * 60 * 60 },
  level2: { enabled: true, tableName: 'embedding_cache' },
  level3: { enabled: true, tableName: 'llm_cache', ttl: 30 * 24 * 60 * 60 }
};
```

### 10.4 ç¼“å­˜å¤±æ•ˆç­–ç•¥

| ç¼“å­˜ç±»å‹ | å¤±æ•ˆæ¡ä»¶ | è¯´æ˜ |
|----------|----------|------|
| æ–‡æ¡£æŒ‡çº¹ | TTLåˆ°æœŸ | ç›¸åŒæ–‡ä»¶7å¤©å†…ç›´æ¥å¤ç”¨ |
| å‘é‡åµŒå…¥ | æ°¸ä¸å¤±æ•ˆ | ç›¸åŒæ–‡æœ¬+æ¨¡å‹æ°¸è¿œç›¸åŒ |
| LLMç»“æœ | TTLåˆ°æœŸ | ç›¸åŒè¯·æ±‚30å¤©å†…å¤ç”¨ |
| æ‰‹åŠ¨æ¸…é™¤ | ç®¡ç†å‘˜æ“ä½œ | ç³»ç»Ÿè®¾ç½®æä¾›"æ¸…é™¤ç¼“å­˜"æŒ‰é’® |

---

## åä¸€ã€LLMè¯„ä¼°æ–¹æ¡ˆ

### 11.1 è¯„ä¼°åœºæ™¯

1. **å¤šç­–ç•¥å†²çªæ—¶**: ä¸¤ä¸ªç­–ç•¥ç»“æœä¸ä¸€è‡´ï¼Œç”¨LLMåˆ¤æ–­å“ªä¸ªæ›´å‡†ç¡®
2. **ç½®ä¿¡åº¦ä½æ—¶**: å•ç­–ç•¥ç»“æœç½®ä¿¡åº¦ä½äºé˜ˆå€¼ï¼Œç”¨LLMè¯„ä¼°è´¨é‡
3. **ç”¨æˆ·å¤æ ¸æ—¶**: ç”¨æˆ·ä¿®æ­£ç»“æœåï¼Œç”¨LLMå¯¹æ¯”åŸç»“æœå­¦ä¹ 

### 11.2 è¯„ä¼°Promptè®¾è®¡

```typescript
// ç›¸ä¼¼åº¦è¯„ä¼°Prompt
const SIMILARITY_EVAL_PROMPT = `
ä½ æ˜¯ä¸€ä¸ªåˆåŒä¿¡æ¯æå–è´¨é‡è¯„ä¼°ä¸“å®¶ã€‚è¯·æ¯”è¾ƒä¸¤ä¸ªæå–ç»“æœçš„ç›¸ä¼¼åº¦ã€‚

åˆåŒåŸæ–‡ï¼ˆç‰‡æ®µï¼‰:
{document_text}

æå–å­—æ®µ: {field_name}
ç»“æœA: {result_a}
ç»“æœB: {result_b}

è¯·è¯„ä¼°ï¼š
1. ä¸¤ä¸ªç»“æœè¯­ä¹‰æ˜¯å¦ç›¸åŒï¼Ÿï¼ˆè€ƒè™‘æ•°å€¼ã€æ—¥æœŸã€åŒä¹‰è¯ç­‰ï¼‰
2. å¦‚æœä¸åŒï¼Œå“ªä¸ªç»“æœæ›´å‡†ç¡®ï¼Ÿ

è¾“å‡ºJSONæ ¼å¼ï¼š
{
  "is_same": boolean,
  "similarity_score": number,  // 0-1
  "better_result": "A" | "B" | "same",
  "reason": string
}
`;
```

### 11.3 è¯„ä¼°æœåŠ¡å®ç°

```typescript
class LLMEvaluatorService {
  async evaluateSimilarity(params: {
    documentText: string;
    fieldName: string;
    resultA: any;
    resultB: any;
  }): Promise<EvaluationResult> {
    const prompt = this.buildPrompt(params);
    const response = await this.llmService.generate(prompt);
    return this.parseResponse(response);
  }

  async evaluateQuality(params: {
    documentText: string;
    fieldName: string;
    result: any;
  }): Promise<QualityScore> {
    // è¯„ä¼°å•ä¸ªç»“æœçš„è´¨é‡
  }
}

interface EvaluationResult {
  isSame: boolean;
  similarityScore: number;  // 0-1
  betterResult: 'A' | 'B' | 'same';
  reason: string;
}
```

### 11.4 è¯„ä¼°é˜ˆå€¼

| ç›¸ä¼¼åº¦åˆ†æ•° | æ“ä½œ |
|-----------|------|
| â‰¥ 0.9 | è§†ä¸ºç›¸åŒï¼Œä»»é€‰å…¶ä¸€ |
| 0.7 - 0.9 | åŸºæœ¬ç›¸åŒï¼Œé€‰ç½®ä¿¡åº¦é«˜çš„ |
| 0.5 - 0.7 | æœ‰å·®å¼‚ï¼Œæ ‡è®°éœ€ç¡®è®¤ |
| < 0.5 | å·®å¼‚å¤§ï¼Œå±•ç¤ºç»™ç”¨æˆ·é€‰æ‹© |

---

## åäºŒã€ç³»ç»Ÿé…ç½®æ‰©å±•

### 12.1 LLMé…ç½®ï¼ˆç°æœ‰ï¼‰

```typescript
interface LLMConfig {
  provider: 'openai' | 'ollama';
  model: string;
  baseUrl?: string;
  apiKey?: string;
  temperature: number;
  maxTokens: number;
  testConnection(): Promise<boolean>;  // âœ… æ–°å¢
}
```

### 12.2 åµŒå…¥æ¨¡å‹é…ç½®ï¼ˆæ–°å¢ï¼‰

```typescript
interface EmbeddingConfig {
  provider: 'ollama' | 'openai' | 'huggingface';
  model: string;
  baseUrl?: string;
  dimensions: number;
  testConnection(): Promise<boolean>;  // âœ… æµ‹è¯•è¿æ¥
}

const defaultEmbeddingConfig: EmbeddingConfig = {
  provider: 'ollama',
  model: 'nomic-embed-text',
  baseUrl: 'http://localhost:11434',
  dimensions: 768
};
```

### 12.3 é…ç½®ç•Œé¢è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç³»ç»Ÿé…ç½® > æ¨¡å‹è®¾ç½®                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                          â”‚
â”‚  LLMè®¾ç½®                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ æä¾›å•†: [Ollama â–¼]                               â”‚    â”‚
â”‚  â”‚ æ¨¡å‹:    [gemma3:27b â–¼]                          â”‚    â”‚
â”‚  â”‚ åœ°å€:    [http://localhost:11434        ]        â”‚    â”‚
â”‚  â”‚                                  [æµ‹è¯•è¿æ¥] âœ“    â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                          â”‚
â”‚  å‘é‡åµŒå…¥æ¨¡å‹è®¾ç½®                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ æä¾›å•†: [Ollama â–¼]                               â”‚    â”‚
â”‚  â”‚ æ¨¡å‹:    [nomic-embed-text â–¼]                   â”‚    â”‚
â”‚  â”‚ åœ°å€:    [http://localhost:11434        ]        â”‚    â”‚
â”‚  â”‚ ç»´åº¦:    [768                     ]              â”‚    â”‚
â”‚  â”‚                                  [æµ‹è¯•è¿æ¥] âœ“    â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                          â”‚
â”‚  ç¼“å­˜è®¾ç½®                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ å¯ç”¨ç¼“å­˜: [âœ“]                                    â”‚    â”‚
â”‚  â”‚ L1ç¼“å­˜:   [å†…å­˜ â–¼]   TTL: [7 å¤©]                â”‚    â”‚
â”‚  â”‚ L2ç¼“å­˜:   [âœ“] å‘é‡åµŒå…¥ç¼“å­˜                       â”‚    â”‚
â”‚  â”‚ L3ç¼“å­˜:   [âœ“] LLMç»“æœç¼“å­˜   TTL: [30 å¤©]        â”‚    â”‚
â”‚  â”‚                                  [æ¸…é™¤æ‰€æœ‰ç¼“å­˜]  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                          â”‚
â”‚                                    [ä¿å­˜é…ç½®]  [é‡ç½®]   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 12.4 æµ‹è¯•è¿æ¥å®ç°

```typescript
async function testEmbeddingConnection(config: EmbeddingConfig): Promise<boolean> {
  try {
    const response = await fetch(`${config.baseUrl}/api/embeddings`, {
      method: 'POST',
      body: JSON.stringify({
        model: config.model,
        prompt: 'test'  // ç®€å•æµ‹è¯•æ–‡æœ¬
      })
    });
    const result = await response.json();
    return result.embedding && result.embedding.length === config.dimensions;
  } catch {
    return false;
  }
}
```

---

## åä¸‰ã€æ•°æ®åº“Schemaå˜æ›´

### 13.1 pgvectoræ‰©å±•

```sql
-- å¯ç”¨pgvectoræ‰©å±•
CREATE EXTENSION IF NOT EXISTS vector;

-- å‘é‡åµŒå…¥ç¼“å­˜è¡¨
CREATE TABLE embedding_cache (
  id SERIAL PRIMARY KEY,
  text_hash VARCHAR(64) NOT NULL,      -- SHA256(text)
  model_name VARCHAR(100) NOT NULL,
  embedding vector(1024),              -- æ ¹æ®æ¨¡å‹ç»´åº¦è°ƒæ•´
  created_at TIMESTAMP DEFAULT NOW(),
  UNIQUE(text_hash, model_name)
);

CREATE INDEX idx_embedding_cache_search ON embedding_cache USING ivfflat (embedding vector_cosine_ops);

-- LLMç»“æœç¼“å­˜è¡¨
CREATE TABLE llm_cache (
  id SERIAL PRIMARY KEY,
  prompt_hash VARCHAR(64) NOT NULL,    -- SHA256(prompt + input)
  model_name VARCHAR(100) NOT NULL,
  response TEXT NOT NULL,
  created_at TIMESTAMP DEFAULT NOW(),
  expires_at TIMESTAMP,
  UNIQUE(prompt_hash, model_name)
);

-- åˆåŒå‘é‡è¡¨ï¼ˆRAGç”¨ï¼‰
CREATE TABLE contract_chunks (
  id SERIAL PRIMARY KEY,
  contract_id INTEGER REFERENCES contracts(id),
  chunk_index INTEGER NOT NULL,
  content TEXT NOT NULL,
  embedding vector(1024),
  created_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_contract_chunks_search ON contract_chunks USING ivfflat (embedding vector_cosine_ops);
CREATE INDEX idx_contract_chunks_contract ON contract_chunks(contract_id, chunk_index);
```

---

## åå››ã€å¾…å®æ–½äº‹é¡¹

| äº‹é¡¹ | ä¼˜å…ˆçº§ | çŠ¶æ€ |
|------|--------|------|
| Doclingé›†æˆ | P0 | å¾…å¼€å‘ |
| å¯æ‰©å±•ä¸»é¢˜æ¶æ„ | P0 | å¾…å¼€å‘ |
| pgvectoræ‰©å±• | P0 | å¾…å¼€å‘ |
| å¤šçº§ç¼“å­˜æœåŠ¡ | P1 | å¾…å¼€å‘ |
| RAGå‘é‡æ£€ç´¢ | P1 | å¾…å¼€å‘ |
| æ¨¡å‹é…ç½®ç•Œé¢ | P1 | å¾…å¼€å‘ |
| æµ‹è¯•è¿æ¥åŠŸèƒ½ | P1 | å¾…å¼€å‘ |
| LLMè¯„ä¼°æœåŠ¡ | P2 | å¾…å¼€å‘ |
| ç­–ç•¥é€‰æ‹©ç•Œé¢ | P2 | å¾…å¼€å‘ |
| å¤šç­–ç•¥å¯¹æ¯”å±•ç¤º | P2 | å¾…å¼€å‘ |
| DSPyç¨‹åºåŒ–æå– | P3 | æš‚ç¼“ |

---

**æ–‡æ¡£çŠ¶æ€**: v1.1 å·²ç¡®è®¤
**ä¸‹ä¸€æ­¥**: Phase 1å¼€å‘å¯åŠ¨
