// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ================================
// 用户与权限
// ================================

model User {
  id           String     @id @default(cuid())
  email        String     @unique
  name         String
  password     String
  role         UserRole   @default(USER)
  departmentId String
  department   Department @relation(fields: [departmentId], references: [id])

  // 状态与密码管理
  isActive              Boolean   @default(true)  // 软删除标记
  mustChangePassword    Boolean   @default(true)  // 首次登录强制改密
  lastPasswordChangedAt DateTime?                 // 最后改密时间

  // 创建者（由管理员创建）
  createdById String?
  createdBy   User?   @relation("UserCreator", fields: [createdById], references: [id])
  createdUsers User[] @relation("UserCreator")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // 关联
  uploadedContracts Contract[] @relation("ContractUploader")
  auditLogs         AuditLog[] @relation("AuditOperator")
  milestoneStatusHistory MilestoneStatusHistory[]
  passwordResetTokens PasswordResetToken[]
  loginRecords       LoginRecord[]
  updatedSystemConfigs SystemConfig[] @relation("SystemConfigUpdater")

  @@index([departmentId])
  @@index([email])
  @@index([isActive])
}

enum UserRole {
  USER       // 普通用户
  DEPT_ADMIN // 部门管理员
  ADMIN      // 系统管理员
}

model Department {
  id       String  @id @default(cuid())
  name     String  @unique
  code     String  @unique // 部门代码（支持动态新增）
  isActive Boolean @default(true) // 软删除标记

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // 关联
  users     User[]
  contracts Contract[] @relation("ContractDepartment")

  @@index([isActive])
}

// ================================
// 客户
// ================================

model Customer {
  id            String         @id @default(cuid())
  name          String         // 客户公司全称
  shortName     String?        // 简称
  creditCode    String?        @unique // 统一社会信用代码
  industry      String?        // 所属行业
  address       String?        // 地址
  contactPerson String?        // 主联系人 (legacy)
  contactPhone  String?        // 联系电话 (legacy)
  contactEmail  String?        // 联系邮箱 (legacy)
  status        CustomerStatus @default(ACTIVE)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // 关联
  contracts Contract[]
  contacts  CustomerContact[]

  @@index([name])
  @@index([creditCode])
  @@index([status])
}

model CustomerContact {
  id         String   @id @default(cuid())
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  name      String  // 联系人姓名
  title     String? // 职务
  phone     String? // 电话
  email     String? // 邮箱
  isPrimary Boolean @default(false) // 是否主联系人

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([customerId])
}

enum CustomerStatus {
  ACTIVE   // 活跃
  INACTIVE // 不活跃
  ARCHIVED // 已归档
}

// ================================
// 合同主表
// ================================

model Contract {
  id String @id @default(cuid())

  // 身份标识
  contractNo String @unique // 合同编号
  name       String // 合同名称

  // 合同类型与状态
  type   ContractType
  status ContractStatus @default(DRAFT)

  // 签约方信息
  ourEntity  String // 我方主体（签约子公司/法律实体）
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id])

  // 财务条款
  amountWithTax    Decimal  @db.Decimal(18, 2) // 含税金额
  amountWithoutTax Decimal? @db.Decimal(18, 2) // 不含税金额
  currency         String   @default("CNY") // 币种
  taxRate          Decimal? @db.Decimal(5, 2) // 税率
  taxAmount        Decimal? @db.Decimal(18, 2) // 税额
  paymentMethod    String? // 付款方式
  paymentTerms     String? // 付款条件

  // 时间周期
  signedAt    DateTime? // 签署日期
  effectiveAt DateTime? // 生效日期
  expiresAt   DateTime? // 终止日期
  duration    String? // 合同期限描述

  // 物理属性
  fileUrl      String? // 合同文件存储路径
  fileType     String? // 文件类型 (pdf/docx)
  copies       Int? // 合同份数
  signLocation String? // 签订地点

  // 分类信息
  industry     String? // 所属行业
  departmentId String
  department   Department @relation("ContractDepartment", fields: [departmentId], references: [id])
  salesPerson  String? // 销售负责人

  // 解析状态
  parseStatus       ParseStatus @default(PENDING)
  parsedAt          DateTime? // 解析完成时间
  parseConfidence   Float? // 解析置信度
  needsManualReview Boolean     @default(false) // 是否需要人工确认

  // 关联主合同（补充协议用）
  parentContractId String?
  parentContract   Contract?  @relation("ContractSupplements", fields: [parentContractId], references: [id])
  supplements      Contract[] @relation("ContractSupplements")

  // 上传信息
  uploadedById String
  uploadedBy   User   @relation("ContractUploader", fields: [uploadedById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // 类型特定关联
  staffAugmentation  StaffAugmentationDetail?
  projectOutsourcing ProjectOutsourcingDetail?
  productSales       ProductSalesDetail?

  // 通用标签
  tags ContractTag[]

  // 法务条款
  legalClauses ContractLegalClause[]

  // 数据保护条款（一对一）
  dataProtection ContractDataProtection?

  // 向量段落（RAG检索）
  chunks ContractChunk[]

  @@index([customerId])
  @@index([type])
  @@index([status])
  @@index([departmentId])
  @@index([signedAt])
  @@index([expiresAt])
  @@index([parentContractId])
}

enum ContractType {
  STAFF_AUGMENTATION  // 人力框架合同
  PROJECT_OUTSOURCING // 项目外包合同
  PRODUCT_SALES       // 产品购销合同
}

enum ContractStatus {
  DRAFT            // 草拟
  PENDING_APPROVAL // 审批中
  ACTIVE           // 已生效
  EXECUTING        // 执行中
  COMPLETED        // 已完结
  TERMINATED       // 已终止
  EXPIRED          // 已过期
}

enum ParseStatus {
  PENDING       // 待解析
  PROCESSING    // 解析中
  COMPLETED     // 解析完成
  FAILED        // 解析失败
  MANUAL_REVIEW // 人工审核中
}

// ================================
// 人力框架合同详情
// ================================

model StaffAugmentationDetail {
  id         String   @id @default(cuid())
  contractId String   @unique
  contract   Contract @relation(fields: [contractId], references: [id], onDelete: Cascade)

  estimatedTotalHours   Int? // 预计总工时
  monthlyHoursCap       Int? // 每月工时上限
  yearlyHoursCap        Int? // 每年工时上限
  settlementCycle       String? // 结算周期
  timesheetApprovalFlow String? // 工时审批流程
  adjustmentMechanism   String? // 工时调整机制
  staffReplacementFlow  String? // 人员更换流程

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // 费率明细
  rateItems StaffRateItem[]
}

model StaffRateItem {
  id       String                  @id @default(cuid())
  detailId String
  detail   StaffAugmentationDetail @relation(fields: [detailId], references: [id], onDelete: Cascade)

  role              String // 人员级别/角色
  rateType          RateType // 计费类型
  rate              Decimal   @db.Decimal(18, 2) // 费率
  rateEffectiveFrom DateTime? // 费率生效日期
  rateEffectiveTo   DateTime? // 费率失效日期

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([detailId])
}

enum RateType {
  HOURLY  // 时薪
  DAILY   // 日薪
  MONTHLY // 月薪
}

// ================================
// 项目外包合同详情
// ================================

model ProjectOutsourcingDetail {
  id         String   @id @default(cuid())
  contractId String   @unique
  contract   Contract @relation(fields: [contractId], references: [id], onDelete: Cascade)

  sowSummary           String? // SOW范围摘要
  deliverables         String? // 关键交付物清单
  acceptanceCriteria   String? // 最终验收标准
  acceptanceFlow       String? // 验收流程
  changeManagementFlow String? // 范围变更流程

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // 里程碑
  milestones ProjectMilestone[]
}

model ProjectMilestone {
  id       String                   @id @default(cuid())
  detailId String
  detail   ProjectOutsourcingDetail @relation(fields: [detailId], references: [id], onDelete: Cascade)

  sequence           Int // 顺序
  name               String // 里程碑名称
  deliverables       String? // 该里程碑交付物
  amount             Decimal?        @db.Decimal(18, 2) // 对应金额
  paymentPercentage  Decimal?        @db.Decimal(5, 2) // 付款比例
  plannedDate        DateTime? // 计划完成日期
  actualDate         DateTime? // 实际完成日期
  acceptanceCriteria String? // 验收标准
  status             MilestoneStatus @default(PENDING)

  // 交付物文件信息
  deliverableFileUrl  String? // 交付物文件URL
  deliverableFileName String? // 交付物文件名
  deliverableUploadedAt DateTime? // 交付物上传时间

  // 验收相关信息
  acceptedAt    DateTime? // 验收通过时间
  acceptedBy    String?   // 验收人ID
  rejectedAt    DateTime? // 拒绝时间
  rejectedBy    String?   // 拒绝人ID
  rejectionReason String? // 拒绝原因

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // 状态历史记录
  statusHistory MilestoneStatusHistory[]

  @@index([detailId])
  @@index([sequence])
  @@index([status])
}

model MilestoneStatusHistory {
  id          String           @id @default(cuid())
  milestoneId String
  milestone   ProjectMilestone @relation(fields: [milestoneId], references: [id], onDelete: Cascade)

  fromStatus MilestoneStatus // 变更前状态
  toStatus   MilestoneStatus // 变更后状态
  changedBy  String // 变更人ID
  changedAt  DateTime @default(now()) // 变更时间
  notes      String? // 备注

  user User @relation(fields: [changedBy], references: [id], onDelete: Cascade)

  @@index([milestoneId])
  @@index([changedBy])
  @@index([changedAt])
}

enum MilestoneStatus {
  PENDING     // 待开始
  IN_PROGRESS // 进行中
  DELIVERED   // 已交付
  ACCEPTED    // 已验收
  REJECTED    // 被拒绝
}

// ================================
// 产品购销合同详情
// ================================

model ProductSalesDetail {
  id         String   @id @default(cuid())
  contractId String   @unique
  contract   Contract @relation(fields: [contractId], references: [id], onDelete: Cascade)

  deliveryContent        String? // 交付内容
  deliveryDate           DateTime? // 交付日期
  deliveryLocation       String? // 交付地点
  shippingResponsibility String? // 运输与保险责任
  ipOwnership            String? // 知识产权归属
  warrantyPeriod         String? // 保修期
  afterSalesTerms        String? // 售后服务条款

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // 产品明细
  lineItems ProductLineItem[]
}

model ProductLineItem {
  id       String             @id @default(cuid())
  detailId String
  detail   ProductSalesDetail @relation(fields: [detailId], references: [id], onDelete: Cascade)

  productName         String // 产品名称
  specification       String? // 规格与配置
  quantity            Int // 数量
  unit                String  @default("套") // 单位
  unitPriceWithTax    Decimal @db.Decimal(18, 2) // 含税单价
  unitPriceWithoutTax Decimal? @db.Decimal(18, 2) // 不含税单价
  subtotal            Decimal @db.Decimal(18, 2) // 小计

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([detailId])
}

// ================================
// 合同标签
// ================================

model Tag {
  id       String  @id @default(cuid())
  name     String  @unique
  category String  @default("默认") // 标签类别
  color    String  @default("#3b82f6") // 显示颜色
  isActive Boolean @default(true) // 软删除标记
  isSystem Boolean @default(false) // 系统自动提取的标签

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  contracts ContractTag[]

  @@index([category])
  @@index([isActive])
}

model ContractTag {
  id         String   @id @default(cuid())
  contractId String
  contract   Contract @relation(fields: [contractId], references: [id], onDelete: Cascade)
  tagId      String
  tag        Tag      @relation(fields: [tagId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([contractId, tagId])
  @@index([contractId])
  @@index([tagId])
}

// ================================
// 审计日志
// ================================

model AuditLog {
  id         String   @id @default(cuid())
  action     String   // 操作类型：CREATE_USER, UPDATE_USER, DELETE_TAG, etc.
  entityType String   // 实体类型：USER, DEPARTMENT, TAG
  entityId   String   // 实体ID
  entityName String?  // 实体名称（方便展示）
  oldValue   Json?    // 变更前数据
  newValue   Json?    // 变更后数据
  operatorId String   // 操作者ID
  operator   User     @relation("AuditOperator", fields: [operatorId], references: [id])
  ipAddress  String?  // 操作者IP
  userAgent  String?  // 操作者浏览器

  createdAt DateTime @default(now())

  @@index([action])
  @@index([entityType])
  @@index([operatorId])
  @@index([createdAt])
}

// ================================
// 密码重置
// ================================

model PasswordResetToken {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  token     String   @unique  // 重置令牌
  expiresAt DateTime // 过期时间
  usedAt    DateTime? // 使用时间
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
}

// ================================
// 登录历史
// ================================

model LoginRecord {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  ipAddress String?  // IP地址
  userAgent String?  // 用户代理
  success   Boolean  // 是否成功
  failureReason String? // 失败原因
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([createdAt])
  @@index([success])
}

// ================================
// 系统配置
// ================================

model SystemConfig {
  id              String   @id @default(cuid())
  key             String   @unique // 配置键 (如: llm.provider, llm.model, smtp.enabled)
  value           String   // 配置值 (JSON字符串)
  category        String   // 配置分类 (llm, smtp, storage)
  description     String?  // 配置描述
  updatedAt       DateTime @updatedAt
  updatedBy       String?  // 更新者ID
  updatedByUser   User?    @relation("SystemConfigUpdater", fields: [updatedBy], references: [id])

  @@index([category])
  @@index([key])
}

// ================================
// 向量存储与缓存 (pgvector)
// ================================

/// 向量嵌入缓存表 - 缓存文本的向量嵌入
model EmbeddingCache {
  id        Int      @id @default(autoincrement())
  textHash  String   // SHA256哈希
  modelName String   // 模型名称
  embedding Unsupported("vector(1024)")?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([textHash, modelName], map: "embedding_cache_text_model_unique")
  @@index([textHash, modelName])
  @@map("embedding_cache")
}

/// LLM结果缓存表
model LlmCache {
  id         Int      @id @default(autoincrement())
  promptHash String   // SHA256(prompt + input)
  modelName  String   // 模型名称
  request    String   @db.Text // 原始请求
  response   String   @db.Text // LLM响应
  createdAt  DateTime @default(now())
  expiresAt  DateTime? // 过期时间

  @@unique([promptHash, modelName], map: "llm_cache_prompt_model_unique")
  @@index([promptHash, modelName])
  @@index([expiresAt])
  @@map("llm_cache")
}

/// 合同段落向量表 - 用于RAG检索
model ContractChunk {
  id         Int       @id @default(autoincrement())
  contractId String    // 关联Contract.id (String类型)
  chunkIndex Int       // 段落索引
  content    String    @db.Text // 段落内容
  embedding  Unsupported("vector(1024)")?
  chunkType  String?   // 段落类型: header/financial/schedule/party/other
  metadata   Json?     // 额外元数据
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  contract Contract @relation(fields: [contractId], references: [id], onDelete: Cascade)

  @@unique([contractId, chunkIndex], map: "contract_chunks_contract_index_unique")
  @@index([contractId, chunkIndex])
  @@map("contract_chunks")
}

/// 文档指纹缓存表 - 同一文档的解析结果缓存
model DocumentFingerprint {
  id          Int      @id @default(autoincrement())
  fileHash    String   @unique // SHA256(文件内容)
  fileName    String
  fileSize    Int
  mimeType    String
  parseResult Json     // 解析结果
  strategy    String   // 使用的解析策略
  createdAt   DateTime @default(now())
  expiresAt   DateTime? // 过期时间(默认7天)

  @@index([fileHash])
  @@index([expiresAt])
  @@map("document_fingerprint")
}

// ================================
// 法务条款提取与存储 (SPEC-31)
// ================================

model ContractLegalClause {
  id         Int     @id @default(autoincrement())
  contractId String
  contract   Contract @relation(fields: [contractId], references: [id], onDelete: Cascade)

  // 条款类型
  clauseType LegalClauseType

  // ========== 知识产权条款 INTELLECTUAL_PROPERTY ==========
  // 许可范围：独占许可、非独占许可、普通许可等
  licenseType String? // 独占/非独占/普通

  // 许可费用描述（可能为"免费"、"按实际使用量"、"固定金额"等）
  licenseFee String? @db.Text

  // ========== 担保条款 GUARANTEE ==========
  // 担保方：甲方、乙方、第三方
  guarantor String? // FIRST_PARTY/SECOND_PARTY/THIRD_PARTY

  // 担保类型：一般保证、连带责任保证
  guaranteeType String? // GENERAL/JOINT_AND_SEVERAL

  // 担保金额（数字）
  guaranteeAmount Decimal? @db.Decimal(20, 2)

  // 担保期限描述（如"合同履行期内"、"质保期2年"）
  guaranteePeriod String? @db.Text

  // ========== 责任限制条款 LIABILITY_LIMITATION ==========
  // 责任上限金额
  liabilityLimit Decimal? @db.Decimal(20, 2)

  // 除外责任类型（JSON数组或文本描述）
  exclusions String? @db.Text

  // 赔偿计算方式
  compensationMethod String? @db.Text

  // ========== 终止与争议条款 TERMINATION_DISPUTE ==========
  // 便利终止通知期（如"30天"、"60天"）
  terminationNotice String?

  // 违约责任描述
  breachLiability String? @db.Text

  // 争议解决方式（仲裁/诉讼）
  disputeResolution String? // ARBITRATION/LITIGATION/NEGOTIATION

  // 争议解决地点（如"北京"、"新加坡"）
  disputeLocation String?

  // ========== 通用字段 ==========
  // AI提取的置信度 (0-1)
  confidence Float?

  // 原始文本引用（用于溯源）
  originalText String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([contractId])
  @@index([clauseType])
  @@map("contract_legal_clause")
}

enum LegalClauseType {
  INTELLECTUAL_PROPERTY // 知识产权条款
  GUARANTEE            // 担保条款
  LIABILITY_LIMITATION // 责任限制条款
  TERMINATION_DISPUTE  // 终止与争议条款
}

// ================================
// 数据保护条款提取与存储 (SPEC-32)
// ================================

model ContractDataProtection {
  id         Int      @id @default(autoincrement())
  contractId String   @unique
  contract   Contract @relation(fields: [contractId], references: [id], onDelete: Cascade)

  // 是否涉及个人数据
  involvesPersonalData Boolean @default(false)

  // 个人数据类型描述（如"用户姓名、联系方式、身份证号等"）
  personalDataType String? @db.Text

  // 数据处理地点限制（如"仅限中国大陆境内"）
  processingLocation String?

  // 跨境传输要求（如"需获得用户单独同意"、"通过安全评估"）
  crossBorderTransfer String? @db.Text

  // 安全措施要求（如"加密存储"、"访问控制"）
  securityMeasures String? @db.Text

  // 数据保留期限（如"合同终止后3年"）
  dataRetention String?

  // 风险等级 (NONE/LOW/MEDIUM/HIGH)
  riskLevel String @default("NONE")

  // AI提取的置信度 (0-1)
  confidence Float?

  // 原始文本引用
  originalText String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([contractId])
  @@index([involvesPersonalData])
  @@index([riskLevel])
  @@map("contract_data_protection")
}

enum DataProtectionRisk {
  NONE
  LOW
  MEDIUM
  HIGH
}
