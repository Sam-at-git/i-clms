# PITFALLS.md - Ralph执行经验教训

记录 Ralph 循环中遇到的坑和经验教训，避免重蹈覆辙。

---

## PIT-001: 功能描述与验收标准不一致

**日期**: 2026-01-18

**问题描述**:
合同列表页规格说明中提到了「新增合同按钮」，但验收标准 (AC-04) 中没有包含此项，导致功能遗漏。

**涉及文件**:
- `03-specs/06-contract-crud.md`

**规格内容** (第 147 行):
```markdown
#### 合同列表页
- 表格展示合同列表
- 分页控件
- 筛选器（类型/状态/日期）
- 搜索框
- 新增合同按钮  ← 这里写了
```

**验收标准** (AC-04):
```markdown
### AC-04: 前端列表页
- [ ] 合同列表展示
- [ ] 分页功能
- [ ] 基础筛选
# ← 缺少「新增合同按钮」
```

**根因分析**:
1. **Spec 编写时**：功能列表和验收标准没有一一对应
2. **Ralph 执行时**：仅按验收标准勾选，不会主动检查功能列表
3. **后端完整但前端断层**：后端有上传 API (`POST /storage/upload`)、有解析服务 (`parseAndExtract`)、有创建接口 (`createContract`)，但前端没有调用入口

**影响**:
- 用户无法上传合同，核心业务流程不通
- 需要额外修复工作

**解决方案**:
- 补充 `ContractUpload.tsx` 组件
- 在 `ContractList.tsx` 添加「上传合同」按钮
- 提交: `2cec549 feat(web): add contract upload functionality`

**经验教训**:

### 教训 1: 验收标准必须 100% 覆盖功能列表
- 功能列表中的每一项都必须在验收标准中有对应检查项
- 建议格式：`功能点 → AC-xx: 对应验收项`

### 教训 2: 端到端用户流程验证
- 完成 Spec 后，必须从用户视角走一遍完整流程
- 问自己：「用户如何完成这个任务？入口在哪里？」

### 教训 3: 前后端 Spec 联动检查
- 后端实现了 API，前端必须有调用入口
- 检查清单：
  - [ ] 后端 Mutation → 前端是否有触发按钮？
  - [ ] 后端 Query → 前端是否有展示页面？
  - [ ] 文件上传 → 前端是否有上传组件？

### 教训 4: Spec 编写模板改进
建议在 Spec 模板中增加「用户流程」章节：
```markdown
## 用户流程
1. 用户点击「上传合同」按钮
2. 选择 PDF/Word 文件
3. 系统自动解析提取字段
4. 用户确认/修改字段
5. 点击「创建」完成
```

---

## 检查清单模板

为避免类似问题，后续 Spec 验收时使用此清单：

### 前端功能完整性检查
- [ ] 所有列表页有「新增」入口
- [ ] 所有详情页有「编辑」「删除」入口
- [ ] 所有上传功能有「上传」按钮
- [ ] 所有后端 Mutation 在前端有触发方式
- [ ] 从用户视角完成一次完整操作流程

### Spec 验收标准检查
- [ ] 功能列表每一项都有对应 AC
- [ ] AC 可量化、可验证
- [ ] AC 覆盖前端 + 后端 + 集成

---

## PIT-002: 同一 Spec 内多处功能遗漏

**日期**: 2026-01-18

**问题描述**:
全面检查后发现 `06-contract-crud.md` 中还有多处功能未实现，PIT-001 只是冰山一角。

**涉及文件**:
- `03-specs/06-contract-crud.md`

**遗漏清单**:

| 优先级 | 功能 | Spec 行号 | 现状 |
|--------|------|-----------|------|
| P0 | 编辑按钮/表单 | 153, 182 | ❌ 详情页无编辑入口 |
| P0 | 删除按钮 | 153 | ❌ 详情页无删除入口 |
| P1 | 筛选器（类型/状态/日期）| 145 | ❌ 列表页无筛选器 |
| P1 | 搜索框 | 146 | ❌ 列表页无搜索框 |
| P1 | 文件预览/下载 | 152 | ❌ 详情页无预览功能 |
| P2 | 类型特定详情Tab | 151 | ❌ 无 Tab 切换 |

**后端 Mutation 无前端触发**:

| Mutation | 用途 | 前端入口 |
|----------|------|----------|
| `updateContract` | 更新合同 | ❌ 无 |
| `deleteContract` | 删除合同 | ❌ 无 |
| `autoClassifyContract` | 自动分类 | ❌ 无（可自动调用）|
| `extractTags` | 标签提取 | ❌ 无（可自动调用）|
| `generateProfile` | 合同画像 | ❌ 无（可自动调用）|
| `register` | 用户注册 | ❌ 无注册页面 |

**根因分析**:
1. **AC 覆盖不全**：AC-05 只写了「编辑功能入口」，遗漏了删除
2. **AC 描述模糊**：「基础筛选」不够具体，导致完全没实现
3. **功能列表被忽视**：Spec 功能列表只是「愿景」，AC 才是「验收标准」

**经验教训**:

### 教训 5: AC 必须是功能列表的镜像
```markdown
# 功能列表                    # 对应 AC
- 筛选器（类型/状态/日期）  → AC: 类型筛选下拉框可用
                            → AC: 状态筛选下拉框可用
                            → AC: 日期范围选择器可用
- 搜索框                    → AC: 关键词搜索返回匹配结果
- 编辑/删除操作             → AC: 编辑按钮可点击进入编辑模式
                            → AC: 删除按钮弹出确认后删除
```

### 教训 6: Mutation 必须有对应前端 Action
每个后端 Mutation 在 Spec 中必须说明：
- 谁触发？（用户点击按钮 / 系统自动）
- 在哪触发？（哪个页面/组件）
- 触发后跳转到哪？

---

## 待修复问题清单

以下问题需要后续修复：

### P0 - 阻塞核心流程
- [ ] 合同详情页添加「编辑」按钮和编辑表单
- [ ] 合同详情页添加「删除」按钮和确认弹窗

### P1 - 影响用户体验
- [ ] 合同列表页添加类型筛选下拉框
- [ ] 合同列表页添加状态筛选下拉框
- [ ] 合同列表页添加搜索框
- [ ] 合同详情页添加文件预览/下载按钮

### P2 - 增强功能
- [ ] 合同详情页添加类型特定详情 Tab
- [ ] 合同上传后自动调用智能引擎（分类/标签/画像）
- [ ] 添加用户注册页面（如需开放注册）

---

## 统计

| 类型 | 数量 |
|------|------|
| 功能遗漏 | 8 |
| 配置错误 | 0 |
| 依赖问题 | 0 |
| 其他 | 0 |
