# PITFALLS.md - Ralph执行经验教训

记录 Ralph 循环中遇到的坑和经验教训，避免重蹈覆辙。

---

## PIT-001: 功能描述与验收标准不一致

**日期**: 2026-01-18

**问题描述**:
合同列表页规格说明中提到了「新增合同按钮」，但验收标准 (AC-04) 中没有包含此项，导致功能遗漏。

**涉及文件**:
- `03-specs/06-contract-crud.md`

**规格内容** (第 147 行):
```markdown
#### 合同列表页
- 表格展示合同列表
- 分页控件
- 筛选器（类型/状态/日期）
- 搜索框
- 新增合同按钮  ← 这里写了
```

**验收标准** (AC-04):
```markdown
### AC-04: 前端列表页
- [ ] 合同列表展示
- [ ] 分页功能
- [ ] 基础筛选
# ← 缺少「新增合同按钮」
```

**根因分析**:
1. **Spec 编写时**：功能列表和验收标准没有一一对应
2. **Ralph 执行时**：仅按验收标准勾选，不会主动检查功能列表
3. **后端完整但前端断层**：后端有上传 API (`POST /storage/upload`)、有解析服务 (`parseAndExtract`)、有创建接口 (`createContract`)，但前端没有调用入口

**影响**:
- 用户无法上传合同，核心业务流程不通
- 需要额外修复工作

**解决方案**:
- 补充 `ContractUpload.tsx` 组件
- 在 `ContractList.tsx` 添加「上传合同」按钮
- 提交: `2cec549 feat(web): add contract upload functionality`

**经验教训**:

### 教训 1: 验收标准必须 100% 覆盖功能列表
- 功能列表中的每一项都必须在验收标准中有对应检查项
- 建议格式：`功能点 → AC-xx: 对应验收项`

### 教训 2: 端到端用户流程验证
- 完成 Spec 后，必须从用户视角走一遍完整流程
- 问自己：「用户如何完成这个任务？入口在哪里？」

### 教训 3: 前后端 Spec 联动检查
- 后端实现了 API，前端必须有调用入口
- 检查清单：
  - [ ] 后端 Mutation → 前端是否有触发按钮？
  - [ ] 后端 Query → 前端是否有展示页面？
  - [ ] 文件上传 → 前端是否有上传组件？

### 教训 4: Spec 编写模板改进
建议在 Spec 模板中增加「用户流程」章节：
```markdown
## 用户流程
1. 用户点击「上传合同」按钮
2. 选择 PDF/Word 文件
3. 系统自动解析提取字段
4. 用户确认/修改字段
5. 点击「创建」完成
```

---

## 检查清单模板

为避免类似问题，后续 Spec 验收时使用此清单：

### 前端功能完整性检查
- [ ] 所有列表页有「新增」入口
- [ ] 所有详情页有「编辑」「删除」入口
- [ ] 所有上传功能有「上传」按钮
- [ ] 所有后端 Mutation 在前端有触发方式
- [ ] 从用户视角完成一次完整操作流程

### Spec 验收标准检查
- [ ] 功能列表每一项都有对应 AC
- [ ] AC 可量化、可验证
- [ ] AC 覆盖前端 + 后端 + 集成

---

## 统计

| 类型 | 数量 |
|------|------|
| 功能遗漏 | 1 |
| 配置错误 | 0 |
| 依赖问题 | 0 |
| 其他 | 0 |
